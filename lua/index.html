



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/dasch-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.2">
    
    
      
        <title>Lua - SIPI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../assets/style/theme.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-blue" data-md-color-accent="deep-blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#customizing-sipi-with-lua-scripts" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="SIPI Documentation" class="md-header-nav__button md-logo">
          
            <img src="../assets/images/dasch-icon-white.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              SIPI Documentation
            </span>
            <span class="md-header-nav__topic">
              
                Lua
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="SIPI Documentation" class="md-nav__button md-logo">
      
        <img src="../assets/images/dasch-icon-white.svg" width="48" height="48">
      
    </a>
    SIPI Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../building/" title="Building" class="md-nav__link">
      Building
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../running/" title="Running" class="md-nav__link">
      Running
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Lua
      </label>
    
    <a href="./" title="Lua" class="md-nav__link md-nav__link--active">
      Lua
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#custom-routes" class="md-nav__link">
    Custom Routes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication-and-authorization" class="md-nav__link">
    Authentication and Authorization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-uploads-to-sipi" class="md-nav__link">
    File uploads to SIPI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipi-functions-available-to-lua-scripts" class="md-nav__link">
    Sipi Functions Available to Lua Scripts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#serversetbuffer" class="md-nav__link">
    server.setBuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsftype" class="md-nav__link">
    server.fs.ftype
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsmodtime" class="md-nav__link">
    server.fs.modtime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsis95readable" class="md-nav__link">
    server.fs.is_readable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsis95writeable" class="md-nav__link">
    server.fs.is_writeable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsis95executable" class="md-nav__link">
    server.fs.is_executable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsexists" class="md-nav__link">
    server.fs.exists
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsunlink" class="md-nav__link">
    server.fs.unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsmkdir" class="md-nav__link">
    server.fs.mkdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsrmdir" class="md-nav__link">
    server.fs.rmdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsgetcwd" class="md-nav__link">
    server.fs.getcwd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsreaddir" class="md-nav__link">
    server.fs.readdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfschdir" class="md-nav__link">
    server.fs.chdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfscopyfile" class="md-nav__link">
    server.fs.copyFile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsmovefile" class="md-nav__link">
    server.fs.moveFile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serveruuid" class="md-nav__link">
    server.uuid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serveruuid62" class="md-nav__link">
    server.uuid62
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serveruuid95to95base62" class="md-nav__link">
    server.uuid_to_base62
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverbase6295to95uuid" class="md-nav__link">
    server.base62_to_uuid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverprint" class="md-nav__link">
    server.print
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverhttp" class="md-nav__link">
    server.http
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servertable95to95json" class="md-nav__link">
    server.table_to_json
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverjson95to95table" class="md-nav__link">
    server.json_to_table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversendheader" class="md-nav__link">
    server.sendHeader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversendcookie" class="md-nav__link">
    server.sendCookie
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversendstatus" class="md-nav__link">
    server.sendStatus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servergenerate95jwt" class="md-nav__link">
    server.generate_jwt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverdecode95jwt" class="md-nav__link">
    server.decode_jwt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfile95mimetype" class="md-nav__link">
    server.file_mimetype
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverrequireauth" class="md-nav__link">
    server.requireAuth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servercopytmpfile" class="md-nav__link">
    server.copyTmpfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversystime" class="md-nav__link">
    server.systime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverlog" class="md-nav__link">
    server.log
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipi-variables-available-to-lua-scripts" class="md-nav__link">
    Sipi Variables Available to Lua Scripts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-helper-functions" class="md-nav__link">
    Lua helper functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helperfilename95hash" class="md-nav__link">
    helper.filename_hash
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-image-functions" class="md-nav__link">
    Lua image functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sipiimagenewfilename" class="md-nav__link">
    SipiImage.new(filename)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagedims" class="md-nav__link">
    SipiImage.dims()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagecropiiif-region-string" class="md-nav__link">
    SipiImage.crop(&lt;iiif-region-string&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagescaleiiif-size-string" class="md-nav__link">
    SipiImage.scale(&lt;iiif-size-string&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagerotateiiif-rotation-string" class="md-nav__link">
    SipiImage.rotate(&lt;iiif-rotation-string&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagewatermarkwm-file-path" class="md-nav__link">
    SipiImage.watermark(&lt;wm-file-path&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagewritefilepath" class="md-nav__link">
    SipiImage.write(&lt;filepath&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagesendformat" class="md-nav__link">
    SipiImage.send(&lt;format&gt;)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-lua-modules" class="md-nav__link">
    Installing Lua modules
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-sqlite-in-lua-scripts" class="md-nav__link">
    Using SQLite in Lua Scripts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opening-an-sqlite-database" class="md-nav__link">
    Opening an SQLite Database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-a-query" class="md-nav__link">
    Executing a Query
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../developing/" title="Developing" class="md-nav__link">
      Developing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../0-release-notes/" title="Release-Notes" class="md-nav__link">
      Release-Notes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#custom-routes" class="md-nav__link">
    Custom Routes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication-and-authorization" class="md-nav__link">
    Authentication and Authorization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-uploads-to-sipi" class="md-nav__link">
    File uploads to SIPI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipi-functions-available-to-lua-scripts" class="md-nav__link">
    Sipi Functions Available to Lua Scripts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#serversetbuffer" class="md-nav__link">
    server.setBuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsftype" class="md-nav__link">
    server.fs.ftype
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsmodtime" class="md-nav__link">
    server.fs.modtime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsis95readable" class="md-nav__link">
    server.fs.is_readable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsis95writeable" class="md-nav__link">
    server.fs.is_writeable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsis95executable" class="md-nav__link">
    server.fs.is_executable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsexists" class="md-nav__link">
    server.fs.exists
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsunlink" class="md-nav__link">
    server.fs.unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsmkdir" class="md-nav__link">
    server.fs.mkdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsrmdir" class="md-nav__link">
    server.fs.rmdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsgetcwd" class="md-nav__link">
    server.fs.getcwd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsreaddir" class="md-nav__link">
    server.fs.readdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfschdir" class="md-nav__link">
    server.fs.chdir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfscopyfile" class="md-nav__link">
    server.fs.copyFile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfsmovefile" class="md-nav__link">
    server.fs.moveFile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serveruuid" class="md-nav__link">
    server.uuid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serveruuid62" class="md-nav__link">
    server.uuid62
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serveruuid95to95base62" class="md-nav__link">
    server.uuid_to_base62
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverbase6295to95uuid" class="md-nav__link">
    server.base62_to_uuid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverprint" class="md-nav__link">
    server.print
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverhttp" class="md-nav__link">
    server.http
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servertable95to95json" class="md-nav__link">
    server.table_to_json
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverjson95to95table" class="md-nav__link">
    server.json_to_table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversendheader" class="md-nav__link">
    server.sendHeader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversendcookie" class="md-nav__link">
    server.sendCookie
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversendstatus" class="md-nav__link">
    server.sendStatus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servergenerate95jwt" class="md-nav__link">
    server.generate_jwt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverdecode95jwt" class="md-nav__link">
    server.decode_jwt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverfile95mimetype" class="md-nav__link">
    server.file_mimetype
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverrequireauth" class="md-nav__link">
    server.requireAuth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servercopytmpfile" class="md-nav__link">
    server.copyTmpfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serversystime" class="md-nav__link">
    server.systime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serverlog" class="md-nav__link">
    server.log
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sipi-variables-available-to-lua-scripts" class="md-nav__link">
    Sipi Variables Available to Lua Scripts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-helper-functions" class="md-nav__link">
    Lua helper functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helperfilename95hash" class="md-nav__link">
    helper.filename_hash
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-image-functions" class="md-nav__link">
    Lua image functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sipiimagenewfilename" class="md-nav__link">
    SipiImage.new(filename)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagedims" class="md-nav__link">
    SipiImage.dims()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagecropiiif-region-string" class="md-nav__link">
    SipiImage.crop(&lt;iiif-region-string&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagescaleiiif-size-string" class="md-nav__link">
    SipiImage.scale(&lt;iiif-size-string&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagerotateiiif-rotation-string" class="md-nav__link">
    SipiImage.rotate(&lt;iiif-rotation-string&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagewatermarkwm-file-path" class="md-nav__link">
    SipiImage.watermark(&lt;wm-file-path&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagewritefilepath" class="md-nav__link">
    SipiImage.write(&lt;filepath&gt;)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sipiimagesendformat" class="md-nav__link">
    SipiImage.send(&lt;format&gt;)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-lua-modules" class="md-nav__link">
    Installing Lua modules
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-sqlite-in-lua-scripts" class="md-nav__link">
    Using SQLite in Lua Scripts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opening-an-sqlite-database" class="md-nav__link">
    Opening an SQLite Database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-a-query" class="md-nav__link">
    Executing a Query
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="customizing-sipi-with-lua-scripts">Customizing Sipi with Lua Scripts</h1>
<p>Within Sipi, Lua is used to perform authentication and authorization for
IIIF image requests, and to write custom routes.</p>
<p>Sipi provides the Lua interpreter the <a href="https://luarocks.org/">LuaRocks</a>
package manager. Sipi does not use the system's Lua interpreter or
package manager.</p>
<p>The Lua interpreter in Sipi runs in a multithreaded environment: each
request runs in its own thread and has its own Lua interpreter.
Therefore, only Lua packages that are known to be thread-safe may be
used.</p>
<h2 id="custom-routes">Custom Routes</h2>
<p>Custom routes can be defined in Sipi's configuration file using the
<code>routes</code> configuration variable. For example:</p>
<pre><code>routes = {
    {
        method = 'GET',
        route = '/status',
        script = 'get_repository_status.lua'
    },
    {
        method = 'POST',
        route = '/make_thumbnail',
        script = 'make_image_thumbnail.lua'
    }
}
</code></pre>
<p>Sipi looks for these scripts in the directory specified by <code>scriptdir</code>
in its configuration file. The first route that matches the beginning of
the requested URL path will be used.</p>
<h2 id="authentication-and-authorization">Authentication and Authorization</h2>
<p>In Sipi's config file, <code>initscript</code> contains the path of a Lua script
that defines a function called <code>pre_flight</code>. The function takes the
parameters <code>prefix</code>, <code>identifier</code> and, <code>cookie</code>, and is called whenever
an image is requested.</p>
<p>The possible return values of the <code>pre_flight</code> function are as follows.
Note that Lua function's return value may consist of more than one
element (see <a href="http://www.lua.org/pil/5.1.html">Multiple Results</a>):</p>
<ul>
<li>Grant full permissions to access the file identified by <code>filepath</code>:
    <code>return 'allow', filepath</code></li>
<li>
<p>Grant restricted access to the file identified by <code>filepath</code>, in one of the following ways:</p>
<p>:   -   Reduce the image dimensions, e.g. to the default thumbnail
        dimensions:
        <code>return 'restrict:size=' .. "config.thumb_size", filepath</code>
    -   Render the image with a watermark:
        <code>return restrict:watermark=&lt;path-to-watermark&gt;, filepath</code></p>
</li>
<li>
<p>Deny access to the requested file: <code>return 'deny'</code></p>
</li>
</ul>
<p>In the <code>pre_flight</code> function, permission checking can be implemented.
When Sipi is used with <a href="http://www.knora.org/">Knora</a>, the <code>pre_flight</code>
function asks Knora about the user's permissions on the image (see
<code>sipi.init-knora.lua</code>). The scripts <code>Knora_login.lua</code> and
<code>Knora_logout.lua</code> handle the setting and unsetting of a cookie
containing the Knora session ID.</p>
<h2 id="file-uploads-to-sipi">File uploads to SIPI</h2>
<p>Using Lua it is possible to create an upload function for image files.
See the scripts <code>upload.elua</code> and <code>do-upload.elua</code> in the server
directory, or <code>upload.lua</code> in the scripts directory.</p>
<h2 id="sipi-functions-available-to-lua-scripts">Sipi Functions Available to Lua Scripts</h2>
<p>Sipi provides the following functions that can be called from Lua
scripts. Each function returns two values. The first value is <code>true</code> if
the operation succeeded, <code>false</code> otherwise. If the operation succeeded,
the second value is the result of the operation, otherwise it is an
error message.</p>
<h3 id="serversetbuffer">server.setBuffer</h3>
<pre><code>success, errmsg = server.setBuffer([bufsize][,incsize])
</code></pre>
<p>Activates the the connection buffer. Optionally the buffer size and
increment size can be given. Returns <code>true, nil</code> on success or
<code>false, errormsg</code> on failure.</p>
<h3 id="serverfsftype">server.fs.ftype</h3>
<pre><code>success, filetype = server.fs.ftype(filepath)
</code></pre>
<p>Checks the filetype of a given filepath. Returns either <code>true, filetype</code>
(one of <code>"FILE"</code>, <code>"DIRECTORY"</code>, <code>"CHARDEV"</code>, <code>"BLOCKDEV"</code>, <code>"LINK"</code>,
<code>"SOCKET"</code> or <code>"UNKNOWN"</code>) or <code>false, errormsg</code>.</p>
<h3 id="serverfsmodtime">server.fs.modtime</h3>
<pre><code>success, modtime = server.fs.modtime(filepath)
</code></pre>
<p>Retrieves the last modification date of a file in seconds since epoch
UTC. Returns either <code>true</code>, <code>modtime</code> or <code>false</code>, <code>errormsg</code>.</p>
<h3 id="serverfsis95readable">server.fs.is_readable</h3>
<pre><code>success, readable = server.fs.is_readable(filepath)
</code></pre>
<p>Checks if a file is readable. Returns <code>true, readable</code> (boolean) on
success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsis95writeable">server.fs.is_writeable</h3>
<pre><code>success, writeable = server.fs.is_writeable(filepath)
</code></pre>
<p>Checks if a file is writeable. Returns <code>true, writeable</code> (boolean) on
success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsis95executable">server.fs.is_executable</h3>
<pre><code>success, errormsg = server.fs.is_executable(filepath)
</code></pre>
<p>Checks if a file is executable. Returns <code>true, executable</code> (boolean) on
success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsexists">server.fs.exists</h3>
<pre><code>success, exists = server.fs.exists(filepath)
</code></pre>
<p>Checks if a file exists. Checks if a file exists. Returns <code>true, exists</code>
(boolean) on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsunlink">server.fs.unlink</h3>
<pre><code>success, errormsg = server.fs.unlink(filename)
</code></pre>
<p>Deletes a file from the file system. The file must exist and the user
must have write access. Returns <code>true, nil</code> on success or
<code>false, errormsg</code> on failure.</p>
<h3 id="serverfsmkdir">server.fs.mkdir</h3>
<pre><code>success, errormsg = server.fs.mkdir(dirname, [tonumber('0755', 8)])
</code></pre>
<p>Creates a new directory, optionally with the specified permissions.
Returns <code>true, nil</code> on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsrmdir">server.fs.rmdir</h3>
<pre><code>success, errormsg = server.fs.rmdir(dirname)
</code></pre>
<p>Deletes a directory. Returns <code>true, nil</code> on success or <code>false, errormsg</code>
on failure.</p>
<h3 id="serverfsgetcwd">server.fs.getcwd</h3>
<pre><code>success, curdir = server.fs.getcwd()
</code></pre>
<p>Gets the current working directory. Returns <code>true, current_dir</code> on
success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsreaddir">server.fs.readdir</h3>
<pre><code>success, filenames = server.fs.readdir(dirname)
</code></pre>
<p>Gets the names of the files in a directory, not including <code>.</code> and <code>..</code>.
Returns <code>true, table</code> on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfschdir">server.fs.chdir</h3>
<pre><code>success, oldir = server.fs.chdir(newdir)
</code></pre>
<p>Change working directory. Returns <code>true, olddir</code> on success or
<code>false, errormsg</code> on failure.</p>
<h3 id="serverfscopyfile">server.fs.copyFile</h3>
<pre><code>success, errormsg = server.fs.copyFile(source, destination)
</code></pre>
<p>Copies a file from source to destination. Returns <code>true, nil</code>on success
or <code>false, errormsg</code> on failure.</p>
<h3 id="serverfsmovefile">server.fs.moveFile</h3>
<pre><code>success, errormsg = server.fs.moveFile(from, to)
</code></pre>
<p>Moves a file. The move connot cross filesystem boundaries! <code>true, nil</code>on
success or <code>false, errormsg</code> on failure.</p>
<h3 id="serveruuid">server.uuid</h3>
<pre><code>success, uuid = server.uuid()
</code></pre>
<p>Generates a random UUID version 4 identifier in canonical form, as
described in <a href="https://tools.ietf.org/html/rfc4122">RFC 4122</a>. Returns
<code>true, uuid</code> on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serveruuid62">server.uuid62</h3>
<pre><code>success, uuid62 = server.uuid62()
</code></pre>
<p>Generates a Base62-encoded UUID. Returns <code>true, uuid62</code> on success or
<code>false, errormsg</code> on failure.</p>
<h3 id="serveruuid95to95base62">server.uuid_to_base62</h3>
<pre><code>success, uuid62 = server.uuid_to_base62(uuid)
</code></pre>
<p>Converts a canonical UUID string to a Base62-encoded UUID. Returns
<code>true, uuid62</code> on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverbase6295to95uuid">server.base62_to_uuid</h3>
<pre><code>success, uuid = server.base62_to_uuid(uuid62)
</code></pre>
<p>Converts a Base62-encoded UUID to canonical form. Returns <code>true, uuid</code>
on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverprint">server.print</h3>
<pre><code>success, errormsg = server.print(values)
</code></pre>
<p>Prints variables and/or strings to the HTTP connection. Returns
<code>true, nil</code> on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverhttp">server.http</h3>
<pre><code>success, result = server.http(method, "http://server.domain[:port]/path/file" [, header] [, timeout])
</code></pre>
<p>Performs an HTTP request. Parameters:</p>
<ul>
<li><code>method</code>: The HTTP request method. Currently must be <code>"GET"</code>.</li>
<li><code>url</code>: The HTTP URL.</li>
<li><code>header</code>: An optional table of key-value pairs representing HTTP
    request headers.</li>
<li><code>timeout</code>: An optional number of milliseconds until the connection
    times out.</li>
</ul>
<p>Authentication is not yet supported.</p>
<p>The result is a table:</p>
<pre><code>result = {
    status_code = value -- HTTP status code returned
    erromsg = "error description" -- only if success is false
    header = {
        name = value [, name = value, ...]
    },
    certificate = { -- only if HTTPS connection
        subject = value,
        issuer = value
    },
    body = data,
    duration = milliseconds
}
</code></pre>
<p>Example:</p>
<pre><code>success, result = server.http("GET", "http://www.salsah.org/api/resources/1", 100)

if (result.success) then
   server.print("&lt;table&gt;")
   server.print("&lt;tr&gt;&lt;th&gt;Field&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;")
   for k,v in pairs(server.header) do
       server.print("&lt;tr&gt;&lt;td&gt;", k, "&lt;/td&gt;&lt;td&gt;", v, "&lt;/td&gt;&lt;/tr&gt;")
   end
   server.print("&lt;/table&gt;&lt;hr/&gt;")

   server.print("Duration: ", result.duration, " ms&lt;br/&gt;&lt;hr/&gt;")
   server.print("Body:&lt;br/&gt;", result.body)
else
   server.print("ERROR: ", result.errmsg)
end
</code></pre>
<h3 id="servertable95to95json">server.table_to_json</h3>
<p>::</p>
<p>:   success, jsonstr = server.table_to_json(table)</p>
<p>Converts a (nested) Lua table to a JSON string. Returns <code>true, jsonstr</code>
on success or <code>false, errormsg</code> on failure.</p>
<h3 id="serverjson95to95table">server.json_to_table</h3>
<pre><code>success, table = server.json_to_table(jsonstr)
</code></pre>
<p>Converts a JSON string to a (nested) Lua table. Returns <code>true, table</code> on
success or <code>false, errormsg</code> on failure.</p>
<h3 id="serversendheader">server.sendHeader</h3>
<pre><code>success, errormsg = server.sendHeader(key, value)
</code></pre>
<p>Sets an HTTP response header. Returns <code>true, nil</code> on success or
<code>false, errormsg</code> on failure.</p>
<h3 id="serversendcookie">server.sendCookie</h3>
<pre><code>success, errormsg = server.sendCookie(key, value [, options-table])
</code></pre>
<p>Sets a cookie in the HTTP response. Returns <code>true, nil</code> on success or
<code>false, errormsg</code> on failure. The optional <code>options-table</code> is a Lua
table containing the following keys:</p>
<ul>
<li><code>path</code></li>
<li><code>domain</code></li>
<li><code>expires</code> (value in seconds)</li>
<li><code>secure</code> (boolean)</li>
<li><code>http_only</code> (boolean)</li>
</ul>
<h3 id="serversendstatus">server.sendStatus</h3>
<pre><code>server.sendStatus(code)
</code></pre>
<p>Sends an HTTP status code. This function is always successful and
returns nothing.</p>
<h3 id="servergenerate95jwt">server.generate_jwt</h3>
<pre><code>success, token = server.generate_jwt(table)
</code></pre>
<p>Generates a <a href="https://jwt.io/">JSON Web Token</a> (JWT) with the table as
payload. Returns <code>true, token</code> on success or <code>false, errormsg</code> on
failure. The table contains the JWT claims as follows. (The type
<code>IntDate</code> is a number of seconds since 1970-01-01T0:0:0Z):</p>
<ul>
<li><code>iss</code> (string =&gt; StringOrURI) OPT: principal that issued the JWT.</li>
<li><code>exp</code> (number =&gt; IntDate) OPT: expiration time on or after which
    the token MUST NOT be accepted for processing.</li>
<li><code>nbf</code> (number =&gt; IntDate) OPT: identifies the time before which
    the token MUST NOT be accepted for processing.</li>
<li><code>iat</code> (number =&gt; IntDate) OPT: identifies the time at which the
    JWT was issued.</li>
<li><code>aud</code> (string =&gt; StringOrURI) OPT: identifies the audience that
    the JWT is intended for. The audience value is a string, typically
    the base address of the resource being accessed, such as
    <code>https://contoso.com</code>.</li>
<li><code>prn</code> (string =&gt; StringOrURI) OPT: identifies the subject of
    the JWT.</li>
<li><code>jti</code> (string =&gt; String) OPT: provides a unique identifier for
    the JWT.</li>
</ul>
<h3 id="serverdecode95jwt">server.decode_jwt</h3>
<pre><code>success, table = server.decode_jwt(token)
</code></pre>
<p>Decodes a <a href="https://jwt.io/">JSON Web Token</a> (JWT) and returns its
content as table. Returns <code>true, table</code> on success or <code>false, errormsg</code>
on failure.</p>
<h3 id="serverfile95mimetype">server.file_mimetype</h3>
<pre><code>success, table = server.file_mimetype(path)
success, table = server.file_mimetype(index)
</code></pre>
<p>Determines the mimetype of a file. The first form is used if the file
path is known. The second form can be used for uploads by passing the
file index. It returns <code>true, table</code> on success or <code>false, errormsg</code> on
failure. The table has 2 members: - <code>mimetype</code> - <code>charset</code></p>
<h3 id="serverrequireauth">server.requireAuth</h3>
<pre><code>success, table = server.requireAuth()
</code></pre>
<p>Gets HTTP authentication data. Returns <code>true, table</code> on success or
<code>false, errormsg</code> on failure. The result is a table:</p>
<pre><code>{
    status = string -- "BASIC" | "BEARER" | "NOAUTH" (no authorization header) | "ERROR"
    username = string -- only if status = "BASIC"
    password = string -- only if status = "BASIC"
    token = string -- only if status = "BEARER"
    message = string -- only if status = "ERROR"
}
</code></pre>
<p>Example:</p>
<pre><code>success, auth = server.requireAuth()
if not success then
    server.sendStatus(501)
    server.print("Error in getting authentication scheme!")
    return -1
end

if auth.status == 'BASIC' then
    --
    -- everything OK, let's create the token for further calls and ad it to a cookie
    --
    if auth.username == config.adminuser and auth.password == config.password then
        tokendata = {
            iss = "sipi.unibas.ch",
            aud = "knora.org",
            user = auth.username
        }
        success, token = server.generate_jwt(tokendata)
        if not success then
            server.sendStatus(501)
            server.print("Could not generate JWT!")
            return -1
        end
        success, errormsg = server.sendCookie('sipi', token, {path = '/', expires = 3600})
        if not success then
            server.sendStatus(501)
            server.print("Couldn't send cookie with JWT!")
            return -1
        end
    else
        server.sendStatus(401)
        server.sendHeader('WWW-Authenticate', 'Basic realm="Sipi"')
        server.print("Wrong credentials!")
        return -1
    end
elseif auth.status == 'BEARER' then
    success, jwt = server.decode_jwt(auth.token)
    if not success then
        server.sendStatus(501)
        server.print("Couldn't deocde JWT!")
        return -1
    end
    if (jwt.iss ~= 'sipi.unibas.ch') or (jwt.aud ~= 'knora.org') or (jwt.user ~= config.adminuser) then
        server.sendStatus(401)
        server.sendHeader('WWW-Authenticate', 'Basic realm="Sipi"')
        return -1
    end
elseif auth.status == 'NOAUTH' then
    server.setBuffer()
    server.sendStatus(401);
    server.sendHeader('WWW-Authenticate', 'Basic realm="Sipi"')
    return -1
else
    server.status(401)
    server.sendHeader('WWW-Authenticate', 'Basic realm="Sipi"')
    return -1
end
</code></pre>
<h3 id="servercopytmpfile">server.copyTmpfile</h3>
<pre><code>success, errormsg = server.copyTmpfile()
</code></pre>
<p>Sipi saves each uploaded file in a temporary location (given by the
config variable <code>tmpdir</code>) and deletes it after the request has been
served. This function is used to copy the file to another location where
it can be retrieved later. Returns <code>true, nil</code> on success or
<code>false, errormsg</code> on failure.</p>
<h3 id="serversystime">server.systime</h3>
<pre><code>systime = server.systime()
</code></pre>
<p>Returns the current system time on the server in seconds since epoch.</p>
<h3 id="serverlog">server.log</h3>
<pre><code>server.log(message, loglevel)
</code></pre>
<p>Writes a message to
<a href="http://man7.org/linux/man-pages/man3/syslog.3.html">syslog</a>. Severity
levels are:</p>
<ul>
<li><code>server.loglevel.LOG_EMERG</code></li>
<li><code>server.loglevel.LOG_ALERT</code></li>
<li><code>server.loglevel.LOG_CRIT</code></li>
<li><code>server.loglevel.LOG_ERR</code></li>
<li><code>server.loglevel.LOG_WARNING</code></li>
<li><code>server.loglevel.LOG_NOTICE</code></li>
<li><code>server.loglevel.LOG_INFO</code></li>
<li><code>server.loglevel.LOG_DEBUG</code></li>
</ul>
<h2 id="sipi-variables-available-to-lua-scripts">Sipi Variables Available to Lua Scripts</h2>
<ul>
<li><code>config.hostname</code>: Hostname where SIPI runs on</li>
<li><code>config.port</code>: Portnumber where SIPI communicates (non SSL)</li>
<li><code>config.sslport</code>: Portnumber for SSL connections of SIPI</li>
<li><code>config.imgroot</code>: Root directory for IIIF-served images</li>
<li><code>config.docroot</code>: Root directory for WEB-Server</li>
<li><code>config.max_temp_file_age</code>: maximum age of temporary files</li>
<li><code>config.prefix_as_path</code>: <code>true</code>if the prefix should be used as
    internal path image directories</li>
<li><code>config.init_script</code>: Path to initialization script</li>
<li><code>config.scriptdir</code>: Path to script directory</li>
<li><code>config.cache_dir</code>: Path to cache directory for iIIF served images</li>
<li><code>config.cache_size</code>: Maximal size of cache</li>
<li><code>config.cache_n_files</code>: Maximal number of files in cache</li>
<li><code>config.cache_hysteresis</code>: Amount fo data to be purged if cache
    reaches maximum size</li>
<li><code>config.keep_alive</code>: keep alive time</li>
<li><code>config.thumb_size</code>: Default thumbnail image size</li>
<li><code>config.n_threads</code>: Number of threads SIPI uses</li>
<li><code>config.max_post_size</code>: Maximal size of POST data allowed</li>
<li><code>config.tmpdir</code>: Temporary directory to store uploads</li>
<li><code>config.knora_path</code>: Path to knora REST API (only for SIPI used
    with Knora)</li>
<li><code>config.knora_port</code>: Port that the Knora API uses</li>
<li><code>config.adminuser</code>: Name of admin user</li>
<li><code>config.password</code>: Password of admin user (use with caution)!</li>
<li><code>server.has_openssl</code>: <code>true</code> if OpenSSL is available.</li>
<li><code>server.secure</code>: <code>true</code> if the connection was made over HTTPS.</li>
<li><code>server.host</code>: the hostname of the Sipi server that was used in
    the request.</li>
<li><code>server.client_ip</code>: the IPv4 or IPv6 address of the client
    connecting to Sipi.</li>
<li><code>server.client_port</code>: the port number of the client socket.</li>
<li><code>server.uri</code>: the URL path used to access Sipi (does not include
    the hostname).</li>
<li><code>server.header</code>: a table containing all the HTTP request headers
    (in lowercase).</li>
<li><code>server.cookies</code>: a table of the cookies that were sent with
    the request.</li>
<li><code>server.get</code>: a table of GET request parameters.</li>
<li><code>server.post</code>: a table of POST or PUT request parameters.</li>
<li><code>server.request</code>: all request parameters.</li>
<li>
<p><code>server.uploads</code>: an array of upload parameters, one per file. Each one is a table containing:</p>
<p>:   -   <code>fieldname</code>: the name of the form field.
    -   <code>origname</code>: the original filename.
    -   <code>tmpname</code>: a temporary path to the uploaded file.
    -   <code>mimetype</code>: the MIME type of the uploaded file as provided
        by the browser.
    -   <code>filesize</code>: the size of uploaded file in bytes.</p>
</li>
</ul>
<h2 id="lua-helper-functions">Lua helper functions</h2>
<h3 id="helperfilename95hash">helper.filename_hash</h3>
<pre><code>success, filepath = helper.filename_hash(fileid)
</code></pre>
<p>if <code>subdir_levels</code> (see configuration file) is &gt; 0, recursive
subdirectories named 'A', 'B',.., 'Z' are used to split the image files
across multiple directories. A simple hash-algorithm is being used. This
function returns a filepath with the subdirectories prepended, e.g
<code>gaga.jp2</code> becomes <code>C/W/gaga.jpg</code></p>
<p>Example:</p>
<pre><code>success, newfilepath = helper.filename_hash(newfilename[imgindex]);
if not success then
    server.sendStatus(500)
    server.log(gaga, server.loglevel.LOG_ERR)
    return false
end

filename = config.imgroot .. '/' .. newfilepath
</code></pre>
<h2 id="lua-image-functions">Lua image functions</h2>
<p>There is an image object implemented which allows to manipulate and
convert images.</p>
<h3 id="sipiimagenewfilename">SipiImage.new(filename)</h3>
<p>The simple forms are:</p>
<pre><code>img = SipiImage.new("filename")
img = SipiImage.new(index)
</code></pre>
<p>The first variant opens a file given by "filename", the second variant
opens an uploaded file directly using the integer index to the uploaded
files.</p>
<p>If the index of an uploaded file is passed as an argument, this method
adds additional metadata to the <code>SipiImage</code> object that is constructed:
the file's original name, its MIME type, and its SHA256 checksum. When
the <code>SipiImage</code> object is then written to another file, this metadata
will be stored in an extra header record.</p>
<p>If a filename is passed, the method does not add this metadata.</p>
<p>The more complex form is as follows:</p>
<pre><code>img = SipiImage.new("filename", {
        region=&lt;iiif-region-string&gt;,
        size=&lt;iiif-size-string&gt;,
        reduce=&lt;integer&gt;,
        original=origfilename,
        hash="md5"|"sha1"|"sha256"|"sha384"|"sha512"
      })
</code></pre>
<p>This creates a new Lua image object and loads the given image into. The
second form allows to indicate a region, the size or a reduce factor and
the original filename. The <code>hash</code> parameter indicates that the given
checksum should be calculated out of the pixel values and written into
the header.</p>
<h3 id="sipiimagedims">SipiImage.dims()</h3>
<pre><code>success, dims = img.dims()
if success then
    server.print('nx=', dims.nx, ' ny=', dims.ny)
end
</code></pre>
<p>Returns the dimensions of the image.</p>
<h3 id="sipiimagecropiiif-region-string">SipiImage.crop(&lt;iiif-region-string&gt;)</h3>
<pre><code>success, errormsg = img.crop(&lt;IIIF-region-string&gt;)
</code></pre>
<p>Crops the image to the given rectangular region. The parameter must be a
valid IIIF-region string.</p>
<h3 id="sipiimagescaleiiif-size-string">SipiImage.scale(&lt;iiif-size-string&gt;)</h3>
<pre><code>success, errormsg = img.scale(&lt;iiif-size-string&gt;)
</code></pre>
<p>Resizes the image to the given size as iiif-conformant size string.</p>
<h3 id="sipiimagerotateiiif-rotation-string">SipiImage.rotate(&lt;iiif-rotation-string&gt;)</h3>
<pre><code>success, errormsg = img.rotate(&lt;iiif-rotation-string&gt;)
</code></pre>
<blockquote>
<p>Rotates and/or mirrors the image according the given iiif-conformant
rotation string.</p>
</blockquote>
<h3 id="sipiimagewatermarkwm-file-path">SipiImage.watermark(&lt;wm-file-path&gt;)</h3>
<pre><code>success, errormsg = img.watermark(&lt;wm-file-path&gt;)
</code></pre>
<p>Applies the given watermark file to the image. The watermark file must
be a bitonal TIFF file.</p>
<h3 id="sipiimagewritefilepath">SipiImage.write(&lt;filepath&gt;)</h3>
<pre><code>success, errormsg = img.write(&lt;filepath&gt;)

success, errormsg = img.write('HTTP.jpg')
</code></pre>
<p>The first version write the image to a file, the second writes the file
to the HTTP connection. The file format is determined by the extension:</p>
<ul>
<li><code>jpg</code> : writes a JPEG file</li>
<li><code>tif</code> : writes a TIFF file</li>
<li><code>png</code> : writes a png file</li>
<li><code>jpx</code> : writes a JPGE2000 file</li>
</ul>
<h3 id="sipiimagesendformat">SipiImage.send(&lt;format&gt;)</h3>
<pre><code>success, errormsg = img.send(&lt;format&gt;)
</code></pre>
<p>Sends the file to the HTTP connection. As format are allowed:</p>
<ul>
<li><code>jpg</code> : writes a JPEG file</li>
<li><code>tif</code> : writes a TIFF file</li>
<li><code>png</code> : writes a png file</li>
<li><code>jpx</code> : writes a JPGE2000 file</li>
</ul>
<h2 id="installing-lua-modules">Installing Lua modules</h2>
<p>To install Lua modules that can be used in Lua scripts, use
<code>local/bin/luarocks</code>. Make sure that the location where the modules are
stored is in the Lua package path, which is printed by
local/bin/lurocks path. The Lua paths will be used by the Lua
interpreter when loading modules in a script with <code>require</code> (see <a href="http://leafo.net/guides/customizing-the-luarocks-tree.html">Using
LuaRocks to install packages in the current
directory</a>).</p>
<p>For example, using <code>local/bin/luarocks install --local package</code>, the
package will be installed in <code>~/.luarocks/</code>. To include this path in the
Lua's interpreter package search path, you can use an environment
variable. Running <code>local/bin/luarocks path</code> outputs the code you can use
to do so. Alternatively, you can build the package path at the beginning
of a Lua file by setting <code>package.path</code> and <code>package.cpath</code> (see
<a href="http://leafo.net/guides/customizing-the-luarocks-tree.html#the-install-locations/using-a-custom-directory/quick-guide/running-scripts-with-packages">Running scripts with
packages</a>).</p>
<h2 id="using-sqlite-in-lua-scripts">Using SQLite in Lua Scripts</h2>
<p>Sipi supports <a href="https://www.sqlite.org/">SQLite</a> 3 databases, which can
be accessed from Lua scripts. You should use
<a href="https://www.lua.org/pil/8.4.html">pcall</a> to handle errors that may be
returned by SQLite.</p>
<h3 id="opening-an-sqlite-database">Opening an SQLite Database</h3>
<pre><code>db = sqlite('db/test.db', 'RW')
</code></pre>
<p>This creates a new opaque database object. The first parameter is the
path to the database file. The second parameter may be <code>'RO'</code> for
read-only access, <code>'RW'</code> for read-write access, or <code>'CRW'</code> for
read-write access. If the database file does not exist, it will be
created using this option.</p>
<p>To destroy the database object and free all resources, you can do this:</p>
<p>``` {.sourceCode .none}
db = ~db</p>
<pre><code>
However, Lua's garbage collection will destroy the database object and
free all resources when they are no longer used.

### Preparing a Query

    qry = db &lt;&lt; 'SELECT * FROM image'

Or, if you want to use a prepared query statement:

    qry = db &lt;&lt; 'INSERT INTO image (id, description) VALUES (?,?)'

`qry` will then be a query object containing a prepared query. If the
query object is not needed anymore, it may be destroyed:

``` {.sourceCode .none}
qry = ~qry
</code></pre>

<p>Query objects should be destroyed explicitly if not needed any longer.</p>
<h3 id="executing-a-query">Executing a Query</h3>
<pre><code>row = qry()
while (row) do
    print(row[0], ' -&gt; ', row[1])
    row = qry()
end
</code></pre>
<p>Or with a prepared statement:</p>
<pre><code>qry('SGV_1960_00315', 'This is an image of a steam engine...')
</code></pre>
<p>The second way is used for prepared queries that contain parameters.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../running/" title="Running" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Running
              </span>
            </div>
          </a>
        
        
          <a href="../developing/" title="Developing" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Developing
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>